{"version":3,"sources":["../../../src/vra/catalog/resources.js"],"names":["requestPromise","promisifyAll","require","module","exports","getResources","getResourceByName","getResourceById","getResourceActions","getResourceActionTemplate","getResourceActionRequests","submitResourceAction","getObjectFromKey","resourceIdKey","limit","_this","resolve","reject","options","method","agent","config","url","hostname","headers","token","body","json","getAsync","then","response","statusCode","resources","content","forEach","resource","res","name","status","id","typeRef","resourceTypeRef","label","push","catch","error","length","Error","resourceName","resourceId","vra","catalog","resourceActionId","actionOptions","actionName","templateData","postUrl","sendRequestViaUrl","array","key","indexOfKey","o","JSON","stringify"],"mappings":"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","file":"resources.js","sourcesContent":["import Promise from 'bluebird'\nimport _findIndex from 'lodash.findindex'\nvar requestPromise = Promise.promisifyAll(require('request'))\n\n/* istanbul ignore next */\nmodule.exports = {\n  getResources: getResources,\n  getResourceByName: getResourceByName,\n  getResourceById: getResourceById,\n  getResourceActions: getResourceActions,\n  getResourceActionTemplate: getResourceActionTemplate,\n  getResourceActionRequests: getResourceActionRequests,\n  submitResourceAction: submitResourceAction,\n  getObjectFromKey: getObjectFromKey\n}\n\nvar resourceIdKey = 'resourceId'\n\nfunction getResources (limit) {\n  var _this = this\n\n  limit = limit || 1000\n\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/catalog-service/api/consumer/resources?limit=${limit}`,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      body: {},\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          return reject(response.body)\n        }\n\n        let resources = []\n        response.body.content.forEach(function (resource) {\n          var res = {}\n          res.name = resource.name\n          res.status = resource.status\n          res.id = resource.id\n          res.typeRef = resource.resourceTypeRef.label\n          resources.push(res)\n        }, this)\n        resolve(resources)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getResourceByName (name) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/catalog-service/api/consumer/resources?limit=1000&$filter=(name eq '${name}')`,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      body: {},\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          return reject(response.body)\n        }\n        if (response.body.content.length === 0) {\n          throw new Error('Unable to find resource with name: ' + name)\n        }\n\n        return resolve(response.body.content[0])\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getResourceById (id) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/catalog-service/api/consumer/resources?limit=1000&$filter=request/id eq '${id}'`,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      body: {},\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          reject(response.body)\n        }\n        if (response.body.content.length === 0) {\n          throw new Error('Unable to find resource with id: ' + id)\n        }\n\n        return resolve(response.body.content[0])\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getResourceActions (resourceName) {\n  var _this = this\n  var resourceId\n\n  return new Promise(function (resolve, reject) {\n    _this.vra.catalog.getResourceByName(resourceName)\n      .then(function (resource) {\n        var options = {\n          method: 'GET',\n          agent: _this.config.agent,\n          url: `https://${_this.config.hostname}/catalog-service/api/consumer/resources/${resource.id}/actions`,\n          headers: {\n            'cache-control': 'no-cache',\n            'content-type': 'application/json',\n            'authorization': `Bearer ${_this.config.token}`\n          },\n          body: {},\n          json: true\n        }\n\n        resourceId = resource.id\n        return requestPromise.getAsync(options)\n      })\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          reject(response.body)\n        } else {\n          response.body.content[resourceIdKey] = resourceId\n          resolve(response.body.content)\n        }\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getResourceActionTemplate (resourceId, resourceActionId) {\n  var _this = this\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/catalog-service/api/consumer/resources/${resourceId}/actions/${resourceActionId}/requests/template`,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      body: {},\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          reject(response.body)\n        } else {\n          resolve(response.body)\n        }\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction submitResourceAction (actionOptions) {\n  var _this = this\n  var resourceActionId\n  var resourceId\n\n  return new Promise(function (resolve, reject) {\n    _this.vra.catalog.getResourceActions(actionOptions.resourceName)\n      .then(function (response) {\n        resourceId = response[resourceIdKey]\n        resourceActionId = getObjectFromKey(response, actionOptions.actionName).id\n\n        return _this.vra.catalog.getResourceActionTemplate(resourceId, resourceActionId)\n      })\n      .then(function (templateData) {\n        var postUrl = `https://${_this.config.hostname}/catalog-service/api/consumer/resources/${resourceId}/actions/${resourceActionId}/requests/`\n\n        return _this.vra.catalog.sendRequestViaUrl(postUrl, templateData)\n      })\n      .then(function (response) {\n        resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getResourceActionRequests (actionOptions) {\n  var _this = this\n  var resourceId\n  var resourceActionId\n\n  return new Promise(function (resolve, reject) {\n    _this.vra.catalog.getResourceActions(actionOptions.resourceName)\n      .then(function (response) {\n        resourceId = response[resourceIdKey]\n        resourceActionId = getObjectFromKey(response, actionOptions.actionName).id\n\n        var options = {\n          method: 'GET',\n          agent: _this.config.agent,\n          url: `https://${_this.config.hostname}/catalog-service/api/consumer/requests?limit=1000&$filter=(resourceAction/id eq '${resourceActionId}' and resource/id eq '${resourceId}')`,\n          headers: {\n            'cache-control': 'no-cache',\n            'content-type': 'application/json',\n            'authorization': `Bearer ${_this.config.token}`\n          },\n          body: {},\n          json: true\n        }\n        return requestPromise.getAsync(options)\n      })\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          reject(response.body)\n        } else {\n          resolve(response.body.content)\n        }\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getObjectFromKey (array, key) {\n  var indexOfKey = _findIndex(array, function (o) {\n    return o.name === key\n  })\n  if (indexOfKey === -1) {\n    throw new Error('Could not find key with the value \\'' + key + '\\' in the array: ' + JSON.stringify(array, null, 2))\n  }\n  return array[indexOfKey]\n}\n"]}