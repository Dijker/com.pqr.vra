{"version":3,"sources":["../../src/vro/categories.js"],"names":["requestPromise","promisifyAll","require","_","find","trim","module","exports","importOne","exportOne","getCategoryIdFromAbsolutePath","getFromCategoryType","getOne","getLeafCategoryId","deleteOne","categoryObj","password","_this","resolve","reject","options","parentId","method","agent","config","url","hostname","headers","Buffer","username","toString","body","name","description","type","json","postAsync","then","response","catch","error","categoryId","encoding","getAsync","categoryType","isRoot","qs","categoryAbsolutePath","vro","categories","deleteNonEmptyContent","deleteAsync","category","parse","categoryPath","dir","base","categoryDecomposedPath","split","rootCategories","rootCategoryName","shift","findCategoryId","rootCategoryId","leafCategoryId","err","categoryName","link","attributes","i","length","attribute","isName","value","currentCategoryId","relations"],"mappings":"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","file":"categories.js","sourcesContent":["import Promise from 'bluebird'\nimport path from 'path'\nimport _find from 'lodash.find'\nimport _trim from 'lodash.trim'\nvar requestPromise = Promise.promisifyAll(require('request'))\n\nvar _ = {\n  find: _find,\n  trim: _trim\n}\n\nmodule.exports = {\n  importOne: importOne,\n  exportOne: exportOne,\n  getCategoryIdFromAbsolutePath: getCategoryIdFromAbsolutePath,\n  getFromCategoryType: getFromCategoryType,\n  getOne: getOne,\n  getLeafCategoryId: getLeafCategoryId,\n  deleteOne: deleteOne\n}\n\nfunction exportOne (categoryObj, password) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options\n    var parentId = categoryObj.parentId || ''\n    options = {\n      method: 'POST',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/vco/api/categories/${parentId}`,\n      headers: {\n        'cache-control': 'no-cache',\n        'authorization': 'Basic ' + new Buffer(_this.config.username + ':' + password).toString('base64'),\n        'accept': 'application/json'\n      },\n      body: {\n        name: categoryObj.name,\n        description: categoryObj.description,\n        type: categoryObj.type\n      },\n      json: true\n    }\n\n    requestPromise.postAsync(options)\n      .then(function (response) {\n        return resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction importOne (categoryId, password) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options\n\n    options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/vco/api/categories/${categoryId}`,\n      headers: {\n        'cache-control': 'no-cache',\n        'authorization': 'Basic ' + new Buffer(_this.config.username + ':' + password).toString('base64'),\n        'accept': 'application/json'\n      },\n      encoding: 'utf-8'\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        return resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getFromCategoryType (categoryType, isRoot, password) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options\n\n    options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/vco/api/categories/`,\n      headers: {\n        'cache-control': 'no-cache',\n        'authorization': 'Basic ' + new Buffer(_this.config.username + ':' + password).toString('base64'),\n        'accept': 'application/json'\n      },\n      qs: {\n        categoryType: categoryType,\n        isRoot: isRoot || false\n      },\n      encoding: 'utf-8',\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        return resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getOne (categoryId, password) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options\n\n    options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/vco/api/categories/${categoryId}`,\n      headers: {\n        'cache-control': 'no-cache',\n        'authorization': 'Basic ' + new Buffer(_this.config.username + ':' + password).toString('base64'),\n        'accept': 'application/json'\n      },\n      encoding: 'utf-8',\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction deleteOne (categoryAbsolutePath, categoryType, password) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    _this.vro.categories.getCategoryIdFromAbsolutePath(categoryAbsolutePath, categoryType, password)\n      .then(function (categoryId) {\n        var options\n\n        options = {\n          method: 'DELETE',\n          agent: _this.config.agent,\n          url: `https://${_this.config.hostname}/vco/api/categories/${categoryId}`,\n          headers: {\n            'cache-control': 'no-cache',\n            'authorization': 'Basic ' + new Buffer(_this.config.username + ':' + password).toString('base64'),\n            'accept': 'application/json'\n          },\n          encoding: 'utf-8',\n          json: true,\n          qs: {\n            deleteNonEmptyContent: true\n          }\n        }\n\n        return requestPromise.deleteAsync(options)\n      }).then(function (response) {\n        resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getCategoryIdFromAbsolutePath (categoryAbsolutePath, categoryType, password) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var category = path.parse(categoryAbsolutePath)\n    var categoryPath = category.dir + '/' + category.base\n    var categoryDecomposedPath = _.trim(categoryPath, '/').split('/')\n\n    // TODO: put in cache for 5 minutes\n    _this.vro.categories.getFromCategoryType(categoryType, true, password)\n      .then(function (response) {\n        var rootCategories = response.body\n        // TODO: put in cache for 5 minutes\n        var rootCategoryName = categoryDecomposedPath.shift()\n        return findCategoryId(rootCategoryName, rootCategories)\n      })\n      .then(function (rootCategoryId) {\n        if (rootCategoryId === -1) {\n          resolve(rootCategoryId)\n        } else {\n          return _this.vro.categories.getLeafCategoryId(rootCategoryId, categoryDecomposedPath, password)\n        }\n      })\n      .then(function (leafCategoryId) {\n        resolve(leafCategoryId)\n      })\n      .catch(function (err) {\n        reject(err)\n      })\n  })\n}\n\nfunction findCategoryId (categoryName, categories) {\n  var categoryId = -1\n  var category = _.find(categories.link, function (link) {\n    if (link.attributes) {\n      for (var i = 0; i < link.attributes.length; i++) {\n        var attribute = link.attributes[i]\n        var isName = attribute.name === 'name' && attribute.value === categoryName\n        if (isName) { return true }\n      }\n    }\n    return false\n  })\n  if (category) {\n    categoryId = _.find(category.attributes, function (attribute) {\n      return attribute.name === 'id'\n    }).value || -1\n  }\n\n  return categoryId\n}\n\nfunction getLeafCategoryId (currentCategoryId, categoryPath, password) {\n  var _this = this\n  return new Promise(function (resolve, reject) {\n    if (categoryPath.length <= 0) {\n      resolve(currentCategoryId)\n    } else {\n      _this.vro.categories.getOne(currentCategoryId, password)\n        .then(function (response) {\n          var category = response.body\n          var categoryName = categoryPath.shift()\n          var categoryId = findCategoryId(categoryName, category.relations)\n          if (categoryId !== -1) {\n            resolve(_this.vro.categories.getLeafCategoryId(categoryId, categoryPath, password))\n          } else {\n            resolve(-1)\n          }\n        })\n        .catch(function (err) {\n          reject(err)\n        })\n    }\n  })\n}\n"]}