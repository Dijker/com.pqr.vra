{"version":3,"sources":["../../../src/vra/catalog/requests.js"],"names":["requestPromise","promisifyAll","require","inProgressState","pendingPreApprovalState","submittedState","preApproved","module","exports","submitRequest","getRequestsByCatalogItemName","getRequest","updateTemplateData","sendRequestViaUrl","catalogItemName","filterMethod","limit","_this","resolve","reject","options","method","agent","config","url","hostname","headers","token","body","json","getAsync","then","response","statusCode","content","catch","error","deploymentOptions","urlRequest","vra","catalog","getCatalogItemByName","blueprintName","urlTemplate","links","href","substring","indexOf","getCatalogItemTemplate","templateData","mergedTemplateData","data","postAsync","params","id","raw","state","requestCompletion","requestCompletionState","dataToBeMerged","node","forEach","elem","path","length","properties","split","property","leaf","value"],"mappings":"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","file":"requests.js","sourcesContent":["import Promise from 'bluebird'\nvar requestPromise = Promise.promisifyAll(require('request'))\n\nvar inProgressState = 'IN_PROGRESS'\nvar pendingPreApprovalState = 'PENDING_PRE_APPROVAL'\nvar submittedState = 'SUBMITTED'\nvar preApproved = 'PRE_APPROVED'\n\n/* istanbul ignore next */\nmodule.exports = {\n  submitRequest: submitRequest,\n  getRequestsByCatalogItemName: getRequestsByCatalogItemName,\n  getRequest: getRequest,\n  updateTemplateData: updateTemplateData,\n  sendRequestViaUrl: sendRequestViaUrl\n}\n\nfunction getRequestsByCatalogItemName (catalogItemName, filterMethod, limit) {\n  var _this = this\n  limit = limit || 10000\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/catalog-service/api/consumer/requests?limit=${limit}&$filter=(catalogItem/name eq '${catalogItemName}')`,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      body: {},\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          return reject(response.body)\n        }\n\n        // could not find any requests with given name\n        if (!response.body || !response.body.content) {\n          return resolve([])\n        }\n\n        resolve(filterMethod(response.body.content))\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction submitRequest (deploymentOptions) {\n  var _this = this\n  var urlRequest\n\n  return new Promise(function (resolve, reject) {\n    _this.vra.catalog.getCatalogItemByName(deploymentOptions.blueprintName)\n      .then(function (response) {\n        var urlTemplate = response.links[0].href\n        urlTemplate = urlTemplate.substring(0, urlTemplate.indexOf('{'))\n\n        urlRequest = response.links[1].href\n        urlRequest = urlRequest.substring(0, urlRequest.indexOf('{'))\n\n        return _this.vra.catalog.getCatalogItemTemplate(urlTemplate)\n      })\n      .then(function (templateData) {\n        return module.exports.updateTemplateData(templateData, deploymentOptions.templateData)\n      })\n      .then(function (mergedTemplateData) {\n        return _this.vra.catalog.sendRequestViaUrl(urlRequest, mergedTemplateData)\n      })\n      .then(function (response) {\n        resolve(response)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction sendRequestViaUrl (url, data) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'POST',\n      agent: _this.config.agent,\n      url: url,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      body: data,\n      json: true\n    }\n\n    requestPromise.postAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200 && response.statusCode !== 201) {\n          return reject(response.body)\n        }\n        resolve(response.body)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction getRequest (params) {\n  var _this = this\n\n  return new Promise(function (resolve, reject) {\n    var options = {\n      method: 'GET',\n      agent: _this.config.agent,\n      url: `https://${_this.config.hostname}/catalog-service/api/consumer/requests/${params.id}`,\n      headers: {\n        'cache-control': 'no-cache',\n        'content-type': 'application/json',\n        'authorization': `Bearer ${_this.config.token}`\n      },\n      json: true\n    }\n\n    requestPromise.getAsync(options)\n      .then(function (response) {\n        if (response.statusCode !== 200) {\n          return reject(response.body)\n        }\n\n        var body = response.body\n        if (params.raw === true) {\n          return resolve(body)\n        }\n\n        if (body.state === inProgressState || body.state === pendingPreApprovalState || body.state === submittedState || body.state === preApproved) {\n          return resolve(inProgressState)\n        }\n\n        var requestCompletion = body.requestCompletion\n        if (requestCompletion) {\n          return resolve(requestCompletion.requestCompletionState)\n        }\n\n        return resolve('ERROR: ' + body.state)\n      })\n      .catch(function (error) {\n        reject(error)\n      })\n  })\n}\n\nfunction updateTemplateData (templateData, dataToBeMerged) {\n  return new Promise(function (resolve, reject) {\n    var node\n    if (dataToBeMerged) {\n      dataToBeMerged.forEach(function (elem) {\n        node = templateData\n        if (elem.path.length > 0) {\n          var properties = elem.path.split('.')\n\n          // access each property. Ex: a.b.c.d\n          properties.forEach(function (property) {\n            node = node[property]\n          })\n        }\n        node[elem.leaf] = elem.value\n      })\n    }\n    resolve(templateData)\n  })\n}\n"]}